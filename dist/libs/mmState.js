define(["./mmPromise","./mmRouter"],function(){function e(){for(var e=E.oldNodes;e.length;){var t=e.length-1,n=e[t];n.parentNode&&n.parentNode.removeChild(n),e.splice(t,1)}}function t(e,t,n){n in t&&(e[n]=t[n],delete t[n])}function n(){return document.getElementsByTagName("avalon")[0]}function a(e){var t,n=document.createDocumentFragment(),a=document.getElementById(e),r=a.eles,o=0;if(a)for(;t=r[o];)n.appendChild(t),o++;return n}function r(e,t){var n,a=document.createDocumentFragment(),r=document.getElementById(e);if(r||(r=document.createElement("div"),r.id=e,b.appendChild(r)),r.eles)avalon.each(r.eles,function(e,t){a.appendChild(t)});else{for(r.eles=[];n=t.firstChild;)a.appendChild(n),r.eles.push(n);P[e]=!0}r.appendChild(a)}function o(e,t,n,a){var o=E.lastLocal;if(o&&(t[0]||e[0])){var i=E._local,s=[];for(var l in o){var c=o[l];if(!(l in i)||i[l]!=c){if(c.$ctrl&&"$onBeforeUnload"in c.$ctrl&&c.$ctrl.$onBeforeUnload(n,a)===!1)return!1;c.element&&e[0]!=t[0]&&s.push(c)}}avalon.each(s,function(e,t){var n=t.element,a=avalon(n).data("currentCache");a&&r(a,n)}),s=null}}function i(e,t,n,a){if(n.hasClass("oni-mmRouter-slide")){var r=t.cloneNode(!0);r.setAttribute("ms-skip","true"),avalon(r).removeClass("oni-mmRouter-enter").addClass("oni-mmRouter-leave"),avalon(t).addClass("oni-mmRouter-enter"),t.parentNode.insertBefore(r,t),E.oldNodes.push(r),v("onViewEnter",a,t,r)}return t}function s(e,t){return avalon.mix(new(avalon.mix(function(){},{prototype:e})),t)}function l(e){return e instanceof Error}function c(e){if(l(e))throw e;v("onError",E,e,e&&e.state)}function u(e){var t=avalon.isFunction(e)?new Promise(e):Promise.all(e);return t}function v(e,t){return N.$fire.apply(N,arguments),avalon.state[e]?avalon.state[e].apply(t||E.currentState,[].slice.call(arguments,2)):0}function f(e,t){if(!(this instanceof f)){var n=_[e]=new f(e,t||{});return n}this.stateName=e,this.formate(t)}function h(){return this instanceof h?void(this.$vmodels=[]):new h}function m(e,t){for(var n in e)if(!(n in t)||e[n]!==t[n])return!1;for(var n in t)if(!(n in e)||e[n]!==t[n])return!1;return!0}function p(e){return _[e]}function d(e,t){var n,t=t||"ms-view";return n=e.querySelectorAll?e.querySelectorAll("["+t+"]"):Array.prototype.filter.call(e.getElementsByTagName("*"),function(e){return"string"==typeof e.getAttribute(t)})}function g(e,t,n){var a=u(function(a,r){var o="function"==typeof e?e(t):e;"string"==typeof o?a(o):(n.message="template必须对应一个字符串或一个返回字符串的函数",r(n))});return a}function y(e,t,n){var a=u(function(a,r){return"function"==typeof e&&(e=e(t)),"string"!=typeof e?(n.message="templateUrl必须对应一个URL",r(n)):avalon.templateCache[e]?a(avalon.templateCache[e]):void avalon.state.templateLoader(e,a,r,n)});return a}function w(e,t,n){var a=u(function(a,r){if("function"==typeof e){var o=e(t);o&&o.then||"string"==typeof o?a(o):(n.message="templateProvider为函数时应该返回一个Promise或thenable对象或字符串",r(n))}else e&&e.then?a(e):(n.message="templateProvider不为函数时应该对应一个Promise或thenable对象",r(n))});return a}function S(e,t,n){return e.template?g(e.template,t,n):e.templateUrl?y(e.templateUrl,t,n):e.templateProvider?w(e.templateProvider,t,n):u(function(e,t){n.message="必须存在template, templateUrl, templateProvider中的一个",t(n)})}avalon.router.route=function(e,t,n,a){t=t.trim();for(var r,o=this.routingTable[e],i=0;r=o[i++];){var s=t.match(r.regexp);if(s&&r["abstract"]!==!0){var l={params:{}};return avalon.mix(l.params,r.params),l.keys=r.keys,l.params.query=n||{},s.shift(),r.keys.length&&this._parseArgs(s,l),void(r.stateName?E.transitionTo(E.currentState,r,l.params,a):r.callback.apply(r,s))}}this.errorback&&this.errorback()};var C,$,_={};avalon.router.go=function(e,t,n){var a=E.currentState,r=f.is(e)?e:p(e),t=t||{};t=avalon.mix(!0,{},r.params,t),r&&E.transitionTo(a,r,t,n)};var N=window.$eventManager=avalon.define("$eventManager",function(e){e.$flag=0,e.uiqKey=function(){return e.$flag++,"flag"+e.$flag++}});N.$watch("onAbort",e);var E=window.mmState={prevState:NaN,currentState:NaN,activeState:NaN,oldNodes:[],query:{},popOne:function(e,t,n,a){var r=e.pop(),o=this;if(!r)return n();if(a&&r.onBeforeExit()===!1)return n(!1);o.activeState=r.parentState||C,r.done=function(i){return r._pending=!1,r.done=null,r._local=null,i!==!1&&o.activeState?o.popOne(e,t,n,a):n(i)};var i=r.onExit();!r._pending&&r.done&&r.done(i)},pushOne:function(e,t,n,a,r){var o=e.shift(),i=this;if(!o)return n();if(o.syncParams(t),o.onBeforeEnter()===!1)return o.syncParams(o.oldParams),n(!1);a=s(a),i.activeState=o,o.done=function(r){if(o.done){if(o._pending=!1,o.done=null,o.visited=!0,r===!1)return n(r);var s=o.callback.apply(o,[t,a]);s.$then(function(r){avalon.mix(!0,o.oldParams,o.params),i.pushOne(e,t,n,a)})}};var l=[];avalon.each(o.keys,function(e,t){var n=t.name;l.push(o.params[n])}),o._onEnter.apply(o,l),!o._pending&&o.done&&o.done()},transitionTo:function(e,t,n,a){var r,n=n||t.params;this.activeState&&this.activeState!=this.currentState&&(avalon.log("navigating to ["+this.currentState.stateName+"] will be stopped, redirect to ["+t.stateName+"] now"),this.activeState.done&&this.activeState.done(!1),e=this.activeState,r=!0);var i,l,c=avalon.router.urlFormate(t.url,n,n.query),u=this,a=a||{},f=a.reload,h=e&&e.chain||[],m=t.chain,p=0,d=m[p],g=C.sourceLocal,y=[];if(!f)for(;d&&d===h[p]&&!d.paramsChanged(n);)g=y[p]=d._local,p++,d=m[p];for(var w=h.slice(p),S=m.slice(p),$=g;d=m[p];)g=y[p]=s(g,d.sourceLocal),p++;return E._local=g,done=function(a,r){return i?void 0:(i=!0,u.currentState=u.activeState,a===!1?v("onError",u,{type:"transition",message:"transitionTo "+t.stateName+" faild",error:r,fromState:e,toState:t,params:n},u.currentState):(E.lastLocal=E.currentState._local,C.fire("updateview",u.currentState,l),avalon.log("transitionTo "+t.stateName+" success"),v("onLoad",u,e,t),void 0))},t.path=("/"+c.path).replace(/^[\/]{2,}/g,"/"),f||e!==t||(l=t.paramsChanged(n))?(E.query=avalon.mix({},n.query),!a||a.confirmed||v("onBeforeUnload",this,e,t)!==!1&&o(w,S,e,t)!==!1?void(i!==!0&&(avalon.log("begin transitionTo "+t.stateName+" from "+(e&&e.stateName||"unknown")),v("onUnload",this,e,t),this.currentState=t,this.prevState=e,c&&avalon.history&&avalon.history.updateLocation(c.path+c.query,avalon.mix({},a,{silent:!0}),!e&&location.hash),v("onBegin",this,e,t),this.popOne(w,n,function(e){return e===!1?done(e):void u.pushOne(S,n,done,$,y)},!(a&&a.confirmed)))):v("onAbort",this,e,t)):t==this.activeState&&r?done():void 0}},P={},b=n();window.loadCache=a,avalon.bindingHandlers.view=function(e,t){function n(n,c,v){if(!document.contains(l))return!1;var m,g=o.data("statename")||"",y=p(g)||C;if(s.indexOf("@")<0&&(s+="@"+y.stateName),m=E.currentState._local&&E.currentState._local[s],(!n||m)&&f!==m){f=m,_currentState=m&&m.state;var w=o.data("viewCache"),S=o.data("currentCache");if(m?w=(m.viewCache===!1?!1:m.viewCache||w)&&s+"@"+_currentState.stateName:w&&(w=s+"@__default__"),!(m&&_currentState===c&&m.ignoreChange&&m.ignoreChange(v,s)||w&&w===S)){i(h,r,o,_currentState);var $,_=m?m.template:u;if(w&&(m?m.element=r:E.currentState._local[s]={state:E.currentState,template:u,element:r}),avalon.clearHTML(r),r.removeAttribute("ms-view"),r.setAttribute("ui-view",e.value),w){if($=P[w]?a(w):avalon.parseHTML(_),r.appendChild($),o.data("currentCache",w),P[w])return}else r.innerHTML=_,o.data("currentCache",!1);!m&&w&&o.data("currentCache",w),avalon.each(d(r),function(e,t){avalon(t).data("statename",_currentState&&_currentState.stateName||"")}),avalon.scan(r,(m&&m.vmodels||[]).concat(t||[])),m&&m.$ctrl&&m.$ctrl.$onRendered&&m.$ctrl.$onRendered.apply(r,[m])}}}var r=(E.currentState,e.element),o=avalon(r),s=e.value,l=document.createComment("ms-view:"+s),c=r.parentNode,u=r.innerHTML,v=o.data("statename")||"",f=(p(v)||C,{}),h=r.outerHTML;r.removeAttribute("ms-view"),c.insertBefore(l,r),n("firsttime"),C.watch("updateview",function(e,t){return n.call(this,$,e,t)})},avalon.state=function(e,t){var n=f(e,t);return avalon.router.get(n.url,function(e,t){var a,r,o=this,i=[],s=[],l=[];return n.resolved=u(function(e,t){a=e,r=t}),avalon.each(n.views,function(e,a){var r=o.params,c={type:"view",name:e,params:r,state:n,view:a},v=t[e]={name:e,state:n,params:n.filterParams(r),ignoreChange:"ignoreChange"in a?a.ignoreChange:o.ignoreChange,viewCache:"viewCache"in a?a.viewCache:o.viewCache},f=S(a,r,c);i.push(f),f.then(function(e){v.template=e},avalon.noop);var h,m=function(e){v.vmodels=e.$vmodels,a.$controller=v.$ctrl=e,p()},p=function(){var e=a.$controller&&a.$controller.$onEnter;if(e){var t=u(function(t,a){var o={type:"data",state:n,params:r},i=e(r,t,function(e){o.message=e,a(o)});i&&i.then?(s.push(i),i.then(function(){t(i)})):i&&i!==!0?(o.message=i,a(o)):i===$&&t()});t=t.then(function(e){avalon.isFunction(e)&&l.push(e)}),s.push(t)}};if(a.$controller&&a.cacheController!==!1)return m(a.$controller);if(a.controller)h=f.then(function(){m(avalon.controller(a.controller))});else if(a.controllerUrl)h=u(function(e,t){var n=avalon.isFunction(a.controllerUrl)?a.controllerUrl(r):a.controllerUrl;n=n instanceof Array?n:[n],avalon.controller.loader(n,function(t){f.then(function(){m(t),e()})})});else if(a.controllerProvider){var d=avalon.isFunction(a.controllerProvider)?a.controllerProvider(r):a.controllerProvider;h=u(function(e,t){d&&d.then?(s.push(d),d.then(function(t){f.then(function(){m(t),e()})},function(e){c.message=e,t(c)})):f.then(function(){m(d),e()})})}h&&h.then&&i.push(h)}),u(i).$then(function(e){n._local=t,u(s).$then(function(){avalon.each(l,function(e,t){t()}),a()})}),n.resolved},n),this},Promise.prototype.$then=function(e,t){var n=this.then(e,t);return n["catch"](c),n},avalon.state.onViewEntered=function(e,t){e!=t&&t.parentNode.removeChild(t)},avalon.state.config=function(e){return avalon.mix(avalon.state,e||{}),avalon},f.is=function(e){return e instanceof f},f.prototype={formate:function(e){avalon.mix(!0,this,e);var n=this.stateName,a=this,r=n.split("."),o=r.length-1,i=a.sourceLocal={};this.chain=[],avalon.each(r,function(e,t){if(e==o)a.chain.push(a);else{var n=r.slice(0,e+1).join("."),i=p(n);if(!i)throw new Error("必须先定义"+n);a.chain.push(i)}}),void 0===this.url&&(this["abstract"]=!0);var l=this.chain[o-1]||C;if(l&&(this.url=l.url+(this.url||""),this.parentState=l),!this.views&&""!=n){var c={};"template,templateUrl,templateProvider,controller,controllerUrl,controllerProvider,viewCache".replace(/\w+/g,function(e){t(c,a,e)});var u="viewname"in this?this.viewname:"";this.views={},this.views[u]=c}var v={};avalon.each(this.views,function(e,t){e.indexOf("@")<0&&(e+="@"+(l?l.stateName||"":"")),v[e]=t,i[e]={}}),this.views=v,this._self=e,this._pending=!1,this.visited=!1,this.params=s(l&&l.params||{}),this.oldParams={},this.keys=[],this.events={}},watch:function(e,t){var n=this.events[e]||[];return this.events[e]=n,n.push(t),t},fire:function(e,t){for(var n=this.events[e]||[],a=0;n[a];){var r=n[a].apply(this,[].slice.call(arguments,1));r===!1?n.splice(a,1):a++}},unwatch:function(e,t){var n=this.events[e];if(n)for(var a=0;n[a];){if(n[a]==t)return n.splice(a,1);a++}},paramsChanged:function(e){var t=!1,n=this.keys,a=this.params;return avalon.each(n,function(n,r){var o=r.name;a[o]!=e[o]&&(t="param")}),t||E.currentState!==this||(t=!m(e.query,E.query)&&"query"),t},filterParams:function(e){var t=avalon.mix(!0,{},this.params),n=this.keys;return avalon.each(n,function(n,a){t[a.name]=e[a.name]}),t},syncParams:function(e){var t=this;avalon.each(this.keys,function(n,a){var r=a.name;r in e&&(t.params[r]=e[r])})},_onEnter:function(){this.query=this.getQuery();var e=this,t=Array.prototype.slice.call(arguments),n=e._async();u(function(a,r){var o={type:"data",state:e,params:e.params},i=function(t){o.message=t,n.apply(e,[!1]),r(o)},s=function(){n.apply(e),a()},l=e.onEnter.apply(e,t.concat([s,i]));l&&l.then?l.then(s)["catch"](c):l&&l!==!0?i(l):l===$&&s()})},getQuery:function(){return E.query},getParams:function(){return this.params},_async:function(){return this.done&&(this._pending=!0),this.done||avalon.noop},onBeforeEnter:avalon.noop,onEnter:avalon.noop,onBeforeExit:avalon.noop,onExit:avalon.noop},C=f("",{url:"",views:null,"abstract":!0}),avalon.controller=function(){var e=arguments[0],t=arguments[1];if(e&&e instanceof h)return e;var n=h();if(avalon.isFunction(e))e(n);else if(avalon.isFunction(t))n.name=e,t(n);else{if("string"!=typeof e&&"object"!=typeof e)throw new Error("参数错误"+arguments);e=e instanceof Array?e:Array.prototype.slice.call(arguments),avalon.each(e,function(t,a){"string"==typeof a&&(e[t]=avalon.vmodels[a]),a=e[t],"$onRendered"in a&&(n.$onRendered=a.$onRendered),"$onEnter"in a&&(n.$onEnter=a.$onEnter)}),n.$vmodels=e}return n},avalon.controller.loader=function(e,t){avalon.require(e,function(e){t&&t(e)})},h.prototype={};var q=function(){return new(window.XMLHttpRequest||ActiveXObject)("Microsoft.XMLHTTP")};avalon.state.templateLoader=function(e,t,n,a){var r=q();r.onreadystatechange=function(){if(4===r.readyState){var o=r.status;o>399&&600>o?(a.message="templateUrl对应资源不存在或没有开启 CORS",a.status=o,a.xhr=r,n(a)):t(avalon.templateCache[e]=r.responseText)}},r.open("GET",e,!0),"withCredentials"in r&&(r.withCredentials=!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send()},window._states=_});